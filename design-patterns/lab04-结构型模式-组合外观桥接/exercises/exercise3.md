# 练习 3: 消息发送系统 (桥接模式)

## 难度
⭐⭐⭐ (困难)

## 学习目标
- 掌握桥接模式的实现
- 理解如何分离抽象和实现
- 学会处理多维度的变化
- 避免类爆炸问题

## 问题描述

设计并实现一个消息发送系统，支持多种消息类型和多种发送方式的组合。系统需要处理两个独立变化的维度：

**消息类型维度**：
- 文本消息
- 图片消息
- 视频消息
- 文件消息

**发送方式维度**：
- 邮件发送
- 短信发送
- 微信发送
- 钉钉发送

任意消息类型都应该能够通过任意发送方式发送，并且可以在运行时动态切换发送方式。

## 功能要求

### 1. 实现层接口

定义 `MessageSender` 接口，包含以下方法：
- `Send(to string, content interface{}) error` - 发送消息
- `GetName() string` - 获取发送方式名称
- `ValidateRecipient(to string) bool` - 验证收件人格式

### 2. 具体实现类

实现以下发送器：

**EmailSender (邮件发送器)**
- 验证邮箱格式
- 支持 HTML 格式
- 支持附件

**SMSSender (短信发送器)**
- 验证手机号格式
- 限制内容长度
- 支持短链接

**WeChatSender (微信发送器)**
- 验证微信 ID
- 支持富文本
- 支持小程序卡片

**DingTalkSender (钉钉发送器)**
- 验证钉钉 ID
- 支持 Markdown 格式
- 支持 @ 提醒

### 3. 抽象层

定义 `Message` 基础结构体，包含：
- 发送器引用
- 收件人
- 发送时间
- 状态（待发送/已发送/失败）

实现以下消息类型：

**TextMessage (文本消息)**
- 纯文本内容
- 支持表情符号
- 字数统计

**ImageMessage (图片消息)**
- 图片 URL 或路径
- 图片尺寸信息
- 缩略图生成

**VideoMessage (视频消息)**
- 视频 URL 或路径
- 视频时长
- 封面图片

**FileMessage (文件消息)**
- 文件路径
- 文件大小
- 文件类型

### 4. 额外功能

- 消息发送历史记录
- 失败重试机制
- 批量发送
- 发送状态回调

## 输入输出示例

### 示例 1: 发送文本消息

**输入**:
```go
// 创建邮件发送器
emailSender := NewEmailSender("smtp.example.com", 587)

// 创建文本消息
textMsg := NewTextMessage(emailSender)
textMsg.SetRecipient("user@example.com")
textMsg.SetContent("Hello, World!")
textMsg.Send()

// 切换为短信发送
smsSender := NewSMSSender("sms.gateway.com")
textMsg.SetSender(smsSender)
textMsg.SetRecipient("13800138000")
textMsg.Send()
```

**输出**:
```
📧 发送文本消息
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  消息类型: 文本消息
  发送方式: Email
  收件人: user@example.com
  内容: Hello, World!
  字数: 13
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  [Email] 通过 smtp.example.com:587 发送
  ✅ 发送成功

📱 发送文本消息
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  消息类型: 文本消息
  发送方式: SMS
  收件人: 13800138000
  内容: Hello, World!
  字数: 13
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  [SMS] 通过网关 sms.gateway.com 发送
  ✅ 发送成功
```

### 示例 2: 发送图片消息

**输入**:
```go
wechatSender := NewWeChatSender("wx-app-001")

imageMsg := NewImageMessage(wechatSender)
imageMsg.SetRecipient("user-123")
imageMsg.SetImageURL("https://example.com/image.jpg")
imageMsg.SetSize(1920, 1080)
imageMsg.Send()
```

**输出**:
```
🖼️  发送图片消息
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  消息类型: 图片消息
  发送方式: WeChat
  收件人: user-123
  图片URL: https://example.com/image.jpg
  尺寸: 1920x1080
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  [WeChat] 通过应用 wx-app-001 发送
  ✅ 发送成功
```

### 示例 3: 批量发送

**输入**:
```go
dingTalkSender := NewDingTalkSender("dingtalk-bot")

fileMsg := NewFileMessage(dingTalkSender)
fileMsg.SetFilePath("/path/to/report.pdf")
fileMsg.SetFileSize(2048) // KB

recipients := []string{"user-001", "user-002", "user-003"}
fileMsg.SendToMultiple(recipients)
```

**输出**:
```
📎 批量发送文件消息
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  消息类型: 文件消息
  发送方式: DingTalk
  文件: report.pdf
  大小: 2048 KB
  收件人数量: 3
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  [1/3] 发送给 user-001 ✅
  [2/3] 发送给 user-002 ✅
  [3/3] 发送给 user-003 ✅
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 批量发送完成: 成功 3, 失败 0
```

## 提示

💡 **提示 1**: 桥接模式的关键是将抽象（消息类型）和实现（发送方式）分离，使两者可以独立变化。

💡 **提示 2**: 抽象层持有实现层的引用，通过接口调用实现层的方法。

💡 **提示 3**: 使用接口定义实现层，便于添加新的发送方式。

💡 **提示 4**: 每种消息类型可以根据自己的特点，在发送前进行特殊处理。

💡 **提示 5**: 考虑使用依赖注入，在创建消息对象时传入发送器。

## 评分标准

- [ ] **功能完整性 (40%)**
  - 正确实现 MessageSender 接口
  - 实现所有消息类型
  - 实现所有发送方式
  - 支持运行时切换发送器

- [ ] **代码质量 (30%)**
  - 代码结构清晰
  - 命名规范
  - 错误处理完善
  - 遵循 Go 语言编码规范

- [ ] **设计模式应用 (20%)**
  - 正确应用桥接模式
  - 抽象和实现分离
  - 避免类爆炸
  - 易于扩展

- [ ] **额外功能 (10%)**
  - 实现发送历史
  - 实现重试机制
  - 实现批量发送
  - 良好的用户体验

## 扩展挑战

如果你完成了基本要求，可以尝试以下扩展功能：

1. **消息队列**
   - 实现消息队列，异步发送
   - 支持优先级队列
   - 支持延迟发送

2. **失败处理**
   - 自动重试机制（指数退避）
   - 失败通知
   - 降级策略（如：邮件发送失败，自动切换到短信）

3. **消息模板**
   - 支持消息模板
   - 变量替换
   - 多语言支持

4. **发送统计**
   - 统计各种发送方式的成功率
   - 统计各种消息类型的发送量
   - 生成统计报表

5. **消息加密**
   - 支持消息内容加密
   - 支持数字签名
   - 支持端到端加密

6. **多发送器组合**
   - 同时使用多个发送器（如：同时发邮件和短信）
   - 主备发送器（主发送器失败时使用备用）
   - 负载均衡（多个发送器轮流使用）

7. **消息追踪**
   - 生成唯一消息 ID
   - 追踪消息状态
   - 查询消息发送历史

## 设计思考

在实现过程中，请思考以下问题：

1. **为什么使用桥接模式？**
   - 如果不使用桥接模式，需要多少个类？
   - 桥接模式如何避免类爆炸？

2. **如何扩展？**
   - 如何添加新的消息类型？
   - 如何添加新的发送方式？
   - 是否需要修改现有代码？

3. **与其他模式的区别**
   - 桥接模式与策略模式有什么区别？
   - 桥接模式与适配器模式有什么区别？

4. **实际应用**
   - 在实际项目中，哪些场景适合使用桥接模式？
   - 桥接模式的优缺点是什么？
