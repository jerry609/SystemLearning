# äº‹ä»¶æ€»çº¿ç³»ç»Ÿ

## é¡¹ç›®èƒŒæ™¯

äº‹ä»¶æ€»çº¿æ˜¯ä¸€ç§åŸºäºè§‚å¯Ÿè€…æ¨¡å¼çš„æ¶ˆæ¯ä¼ é€’æœºåˆ¶ï¼Œå¹¿æ³›åº”ç”¨äºå¾®æœåŠ¡æ¶æ„ã€å‰ç«¯æ¡†æ¶å’Œäº‹ä»¶é©±åŠ¨ç³»ç»Ÿä¸­ã€‚æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„äº‹ä»¶æ€»çº¿ç³»ç»Ÿï¼Œæ”¯æŒäº‹ä»¶çš„æ³¨å†Œã€å‘å¸ƒã€è®¢é˜…å’Œå–æ¶ˆè®¢é˜…ã€‚

## åŠŸèƒ½åˆ—è¡¨

- [x] äº‹ä»¶æ³¨å†Œå’Œè®¢é˜…
- [x] äº‹ä»¶å‘å¸ƒï¼ˆåŒæ­¥å’Œå¼‚æ­¥ï¼‰
- [x] å–æ¶ˆè®¢é˜…
- [x] äº‹ä»¶è¿‡æ»¤
- [x] ä¼˜å…ˆçº§é˜Ÿåˆ—
- [x] äº‹ä»¶å†å²è®°å½•
- [x] çº¿ç¨‹å®‰å…¨
- [x] é”™è¯¯å¤„ç†

## æŠ€æœ¯æ ˆ

- Go 1.21+
- æ ‡å‡†åº“ syncï¼ˆå¹¶å‘æ§åˆ¶ï¼‰
- æ ‡å‡†åº“ testingï¼ˆå•å…ƒæµ‹è¯•ï¼‰

## è®¾è®¡æ¨¡å¼åº”ç”¨

| æ¨¡å¼ | åº”ç”¨ä½ç½® | ä½œç”¨ |
|------|----------|------|
| è§‚å¯Ÿè€…æ¨¡å¼ | EventBus.Subscribe/Publish | å®ç°äº‹ä»¶çš„å‘å¸ƒ-è®¢é˜…æœºåˆ¶ |
| å•ä¾‹æ¨¡å¼ | GlobalEventBus | æä¾›å…¨å±€å”¯ä¸€çš„äº‹ä»¶æ€»çº¿å®ä¾‹ |
| ç­–ç•¥æ¨¡å¼ | EventFilter | æ”¯æŒä¸åŒçš„äº‹ä»¶è¿‡æ»¤ç­–ç•¥ |

## é¡¹ç›®ç»“æ„

```
event-bus-system/
â”œâ”€â”€ README.md           # é¡¹ç›®è¯´æ˜
â”œâ”€â”€ eventbus.go         # äº‹ä»¶æ€»çº¿æ ¸å¿ƒå®ç°
â”œâ”€â”€ main.go             # ç¤ºä¾‹ç¨‹åº
â””â”€â”€ eventbus_test.go    # å•å…ƒæµ‹è¯•
```

## æ ¸å¿ƒç»„ä»¶

### 1. EventBusï¼ˆäº‹ä»¶æ€»çº¿ï¼‰
- ç®¡ç†äº‹ä»¶è®¢é˜…è€…
- å‘å¸ƒäº‹ä»¶åˆ°è®¢é˜…è€…
- æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥å‘å¸ƒ

### 2. Eventï¼ˆäº‹ä»¶ï¼‰
- äº‹ä»¶ç±»å‹
- äº‹ä»¶æ•°æ®
- æ—¶é—´æˆ³

### 3. EventHandlerï¼ˆäº‹ä»¶å¤„ç†å™¨ï¼‰
- å¤„ç†äº‹ä»¶çš„æ¥å£
- å…·ä½“å¤„ç†å™¨å®ç°

### 4. EventFilterï¼ˆäº‹ä»¶è¿‡æ»¤å™¨ï¼‰
- è¿‡æ»¤ä¸éœ€è¦çš„äº‹ä»¶
- æ”¯æŒè‡ªå®šä¹‰è¿‡æ»¤è§„åˆ™

## è¿è¡Œæ–¹å¼

### è¿è¡Œç¤ºä¾‹ç¨‹åº

```bash
cd project/event-bus-system
go run main.go eventbus.go
```

### è¿è¡Œæµ‹è¯•

```bash
go test -v
```

### è¿è¡Œæ€§èƒ½æµ‹è¯•

```bash
go test -bench=. -benchmem
```

## é¢„æœŸè¾“å‡º

```
=== äº‹ä»¶æ€»çº¿ç³»ç»Ÿç¤ºä¾‹ ===

ã€åœºæ™¯ 1: åŸºæœ¬äº‹ä»¶å‘å¸ƒè®¢é˜…ã€‘

âœ“ [ç”¨æˆ·æœåŠ¡] è®¢é˜…äº†äº‹ä»¶: user.created
âœ“ [é‚®ä»¶æœåŠ¡] è®¢é˜…äº†äº‹ä»¶: user.created
âœ“ [æ—¥å¿—æœåŠ¡] è®¢é˜…äº†äº‹ä»¶: user.created

ğŸ“¢ å‘å¸ƒäº‹ä»¶: user.created
   æ•°æ®: map[email:alice@example.com user_id:12345 username:alice]
   è®¢é˜…è€…æ•°é‡: 3

  [ç”¨æˆ·æœåŠ¡] å¤„ç†äº‹ä»¶: user.created
     åˆ›å»ºç”¨æˆ·èµ„æ–™: alice
  [é‚®ä»¶æœåŠ¡] å¤„ç†äº‹ä»¶: user.created
     å‘é€æ¬¢è¿é‚®ä»¶åˆ°: alice@example.com
  [æ—¥å¿—æœåŠ¡] å¤„ç†äº‹ä»¶: user.created
     è®°å½•æ—¥å¿—: ç”¨æˆ· alice å·²åˆ›å»º

ã€åœºæ™¯ 2: å¼‚æ­¥äº‹ä»¶å‘å¸ƒã€‘

å¼‚æ­¥å‘å¸ƒ 3 ä¸ªè®¢å•äº‹ä»¶...

ğŸ“¢ å‘å¸ƒäº‹ä»¶: order.created
   æ•°æ®: map[amount:99.99 order_id:ORD-001]
   è®¢é˜…è€…æ•°é‡: 2

  [è®¢å•æœåŠ¡] å¤„ç†äº‹ä»¶: order.created
     å¤„ç†è®¢å•: ORD-001
  [é€šçŸ¥æœåŠ¡] å¤„ç†äº‹ä»¶: order.created
     å‘é€è®¢å•é€šçŸ¥: ORD-001

...

ã€åœºæ™¯ 3: äº‹ä»¶è¿‡æ»¤ã€‘

âœ“ [VIPç”¨æˆ·æœåŠ¡] è®¢é˜…äº†äº‹ä»¶: user.created (å¸¦è¿‡æ»¤å™¨)

ğŸ“¢ å‘å¸ƒäº‹ä»¶: user.created
   æ•°æ®: map[email:bob@example.com user_id:12346 username:bob vip:false]
   è®¢é˜…è€…æ•°é‡: 1

  [VIPç”¨æˆ·æœåŠ¡] äº‹ä»¶è¢«è¿‡æ»¤: éVIPç”¨æˆ·

ğŸ“¢ å‘å¸ƒäº‹ä»¶: user.created
   æ•°æ®: map[email:charlie@example.com user_id:12347 username:charlie vip:true]
   è®¢é˜…è€…æ•°é‡: 1

  [VIPç”¨æˆ·æœåŠ¡] å¤„ç†äº‹ä»¶: user.created
     ä¸ºVIPç”¨æˆ· charlie æä¾›ç‰¹æ®ŠæœåŠ¡

=== ç¤ºä¾‹ç»“æŸ ===
```

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨

```go
// åˆ›å»ºäº‹ä»¶æ€»çº¿
bus := NewEventBus()

// è®¢é˜…äº‹ä»¶
handler := &MyEventHandler{}
bus.Subscribe("user.created", handler)

// å‘å¸ƒäº‹ä»¶
event := Event{
    Type: "user.created",
    Data: map[string]interface{}{
        "user_id": "12345",
        "username": "alice",
    },
    Timestamp: time.Now(),
}
bus.Publish(event)
```

### å¼‚æ­¥å‘å¸ƒ

```go
// å¼‚æ­¥å‘å¸ƒäº‹ä»¶
bus.PublishAsync(event)
```

### äº‹ä»¶è¿‡æ»¤

```go
// åˆ›å»ºå¸¦è¿‡æ»¤å™¨çš„è®¢é˜…
filter := func(event Event) bool {
    data := event.Data.(map[string]interface{})
    return data["vip"] == true
}

bus.SubscribeWithFilter("user.created", handler, filter)
```

### å–æ¶ˆè®¢é˜…

```go
// å–æ¶ˆè®¢é˜…
bus.Unsubscribe("user.created", handler)
```

## æ‰©å±•å»ºè®®

1. **æŒä¹…åŒ–**: å°†äº‹ä»¶å­˜å‚¨åˆ°æ•°æ®åº“æˆ–æ¶ˆæ¯é˜Ÿåˆ—
2. **åˆ†å¸ƒå¼**: æ”¯æŒè·¨è¿›ç¨‹ã€è·¨ç½‘ç»œçš„äº‹ä»¶ä¼ é€’
3. **é‡è¯•æœºåˆ¶**: äº‹ä»¶å¤„ç†å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•
4. **æ­»ä¿¡é˜Ÿåˆ—**: å¤„ç†å¤±è´¥çš„äº‹ä»¶æ”¾å…¥æ­»ä¿¡é˜Ÿåˆ—
5. **äº‹ä»¶å›æ”¾**: æ”¯æŒé‡æ”¾å†å²äº‹ä»¶
6. **ç›‘æ§ç»Ÿè®¡**: æ·»åŠ äº‹ä»¶å¤„ç†çš„ç›‘æ§å’Œç»Ÿè®¡åŠŸèƒ½
7. **äº‹ä»¶ç‰ˆæœ¬**: æ”¯æŒäº‹ä»¶çš„ç‰ˆæœ¬ç®¡ç†
8. **äº‹ä»¶è½¬æ¢**: æ”¯æŒäº‹ä»¶æ ¼å¼çš„è½¬æ¢

## æ€§èƒ½ä¼˜åŒ–

1. ä½¿ç”¨å¯¹è±¡æ± å‡å°‘å†…å­˜åˆ†é…
2. ä½¿ç”¨ channel ç¼“å†²åŒºæé«˜ååé‡
3. æ‰¹é‡å‘å¸ƒäº‹ä»¶
4. ä½¿ç”¨ goroutine æ± é™åˆ¶å¹¶å‘æ•°
5. å®ç°äº‹ä»¶ä¼˜å…ˆçº§é˜Ÿåˆ—

## æ³¨æ„äº‹é¡¹

1. **çº¿ç¨‹å®‰å…¨**: æ‰€æœ‰å…¬å…±æ–¹æ³•éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„
2. **å†…å­˜æ³„æ¼**: ç¡®ä¿åŠæ—¶å–æ¶ˆä¸å†éœ€è¦çš„è®¢é˜…
3. **æ­»é”**: é¿å…åœ¨äº‹ä»¶å¤„ç†å™¨ä¸­å‘å¸ƒåŒæ­¥äº‹ä»¶
4. **æ€§èƒ½**: å¤§é‡è®¢é˜…è€…æ—¶è€ƒè™‘ä½¿ç”¨å¼‚æ­¥å‘å¸ƒ
5. **é”™è¯¯å¤„ç†**: ä¸€ä¸ªå¤„ç†å™¨çš„é”™è¯¯ä¸åº”å½±å“å…¶ä»–å¤„ç†å™¨

## ç›¸å…³èµ„æº

- [è§‚å¯Ÿè€…æ¨¡å¼è¯¦è§£](../theory/02-observer.md)
- [Go å¹¶å‘ç¼–ç¨‹](https://go.dev/doc/effective_go#concurrency)
- [äº‹ä»¶é©±åŠ¨æ¶æ„](https://martinfowler.com/articles/201701-event-driven.html)
