# 练习 3: 数据导入框架

## 难度
⭐⭐ (中等)

## 学习目标
- 掌握模板方法模式的实现
- 理解算法骨架的定义
- 学会使用钩子方法
- 理解控制反转的概念

## 问题描述

你需要实现一个数据导入框架，支持从不同格式的文件（CSV、JSON、XML）导入数据到数据库。虽然文件格式不同，但导入流程是相同的：读取文件 → 解析数据 → 验证数据 → 转换数据 → 保存到数据库。

## 功能要求

1. **数据导入接口**
   - 定义数据导入的原语操作
   - 读取文件
   - 解析数据
   - 验证数据
   - 转换数据

2. **导入模板**
   - 定义导入流程的算法骨架
   - 实现公共步骤（日志记录、错误处理）
   - 提供钩子方法（前置处理、后置处理）

3. **具体导入器**
   - CSV 导入器：解析 CSV 格式
   - JSON 导入器：解析 JSON 格式
   - XML 导入器：解析 XML 格式

4. **高级功能**
   - 数据验证规则
   - 数据转换规则
   - 错误处理和回滚
   - 导入进度显示

## 输入输出示例

### 示例 1: CSV 数据导入
**输入**:
```go
importer := NewCSVImporter("users.csv")
template := NewDataImportTemplate(importer)
template.Import()
```

**输出**:
```
=== 开始数据导入流程 ===

步骤 0: 前置处理
  检查文件是否存在: users.csv
  文件大小: 1024 字节
✓ 前置处理完成

步骤 1: 读取文件
  从 CSV 文件读取数据...
  读取到 3 行数据
✓ 读取完成

步骤 2: 解析数据
  解析 CSV 格式...
  字段: name, age, email
  记录数: 3
✓ 解析完成

步骤 3: 验证数据
  验证数据格式...
  验证记录 1/3: ✓
  验证记录 2/3: ✓
  验证记录 3/3: ✓
✓ 验证通过

步骤 4: 转换数据
  转换数据为标准格式...
  应用转换规则: 邮箱小写化
  应用转换规则: 年龄范围检查
✓ 转换完成

步骤 5: 保存数据
  保存到数据库...
  插入记录 1/3
  插入记录 2/3
  插入记录 3/3
✓ 保存成功

步骤 6: 后置处理
  生成导入报告...
  清理临时文件...
✓ 后置处理完成

=== 数据导入完成 (耗时: 250ms) ===

导入统计:
  总记录数: 3
  成功: 3
  失败: 0
  成功率: 100%
```

### 示例 2: JSON 数据导入（带验证错误）
**输入**:
```go
importer := NewJSONImporter("users.json")
template := NewDataImportTemplate(importer)
template.Import()
```

**输出**:
```
=== 开始数据导入流程 ===

步骤 0: 前置处理
  检查 API 连接...
  API URL: https://api.example.com/users
✓ 前置处理完成

步骤 1: 读取文件
  从 API 获取 JSON 数据...
  接收到 2048 字节数据
✓ 读取完成

步骤 2: 解析数据
  解析 JSON 格式...
  记录数: 5
✓ 解析完成

步骤 3: 验证数据
  验证数据格式...
  验证记录 1/5: ✓
  验证记录 2/5: ✗ (邮箱格式错误)
  验证记录 3/5: ✓
  验证记录 4/5: ✗ (年龄超出范围)
  验证记录 5/5: ✓
✗ 验证失败: 2 条记录不符合要求

错误处理:
  跳过无效记录
  继续处理有效记录

步骤 4: 转换数据
  转换 3 条有效记录...
✓ 转换完成

步骤 5: 保存数据
  保存到数据库...
  插入记录 1/3
  插入记录 2/3
  插入记录 3/3
✓ 保存成功

步骤 6: 后置处理
  发送导入完成通知...
✓ 后置处理完成

=== 数据导入完成 (耗时: 350ms) ===

导入统计:
  总记录数: 5
  成功: 3
  失败: 2
  成功率: 60%
```

## 提示

💡 **提示 1**: 定义数据导入接口
```go
type DataImporter interface {
    ReadFile() ([]byte, error)
    ParseData([]byte) ([]Record, error)
    ValidateData([]Record) ([]Record, []error)
    TransformData([]Record) ([]Record, error)
    
    // 钩子方法
    BeforeImport() error
    AfterImport() error
}
```

💡 **提示 2**: 实现模板方法
```go
func (t *DataImportTemplate) Import() error {
    // 前置处理
    if err := t.importer.BeforeImport(); err != nil {
        return err
    }
    
    // 读取 → 解析 → 验证 → 转换 → 保存
    
    // 后置处理
    return t.importer.AfterImport()
}
```

💡 **提示 3**: 提供基础实现
```go
type BaseImporter struct{}

func (b *BaseImporter) BeforeImport() error {
    // 默认实现
    return nil
}

func (b *BaseImporter) AfterImport() error {
    // 默认实现
    return nil
}
```

## 评分标准

- [ ] **功能完整性 (40%)**
  - 实现完整的导入流程
  - 支持多种文件格式
  - 实现数据验证和转换
  - 实现钩子方法

- [ ] **代码质量 (30%)**
  - 接口设计合理
  - 模板方法清晰
  - 错误处理完善

- [ ] **设计模式应用 (20%)**
  - 正确使用模板方法模式
  - 算法骨架定义清晰
  - 钩子方法使用恰当

- [ ] **扩展性 (10%)**
  - 易于添加新的文件格式
  - 易于添加新的验证规则

## 扩展挑战

1. **批量导入**: 支持批量导入多个文件
2. **增量导入**: 支持增量导入，只导入新数据
3. **并发导入**: 使用 goroutine 并发处理数据
4. **导入回滚**: 导入失败时回滚已导入的数据
5. **导入调度**: 支持定时导入和触发式导入

## 相关知识点

- 模板方法模式的结构和实现
- 算法骨架的定义
- 钩子方法的使用
- 控制反转（IoC）
- 代码复用
