# ç»ƒä¹  3: å®ç°è¯·æ±‚å¤„ç†ä¸­é—´ä»¶ç³»ç»Ÿ

## éš¾åº¦
â­â­ (ä¸­ç­‰)

## å­¦ä¹ ç›®æ ‡
- æŒæ¡è´£ä»»é“¾æ¨¡å¼çš„å®ç°
- ç†è§£ä¸­é—´ä»¶çš„å·¥ä½œåŸç†
- å­¦ä¼šè®¾è®¡å¯æ‰©å±•çš„è¯·æ±‚å¤„ç†ç®¡é“

## é—®é¢˜æè¿°

è®¾è®¡å¹¶å®ç°ä¸€ä¸ª HTTP è¯·æ±‚å¤„ç†ä¸­é—´ä»¶ç³»ç»Ÿï¼Œæ”¯æŒå¤šä¸ªä¸­é—´ä»¶çš„é“¾å¼å¤„ç†ï¼Œæ¯ä¸ªä¸­é—´ä»¶è´Ÿè´£å¤„ç†è¯·æ±‚çš„æŸä¸ªæ–¹é¢ã€‚

## åŠŸèƒ½è¦æ±‚

### 1. ä¸­é—´ä»¶ç±»å‹
å®ç°ä»¥ä¸‹ä¸­é—´ä»¶ï¼š
- **LoggerMiddleware**: è®°å½•è¯·æ±‚æ—¥å¿—ï¼ˆæ–¹æ³•ã€è·¯å¾„ã€è€—æ—¶ï¼‰
- **AuthMiddleware**: éªŒè¯ç”¨æˆ·èº«ä»½ï¼ˆæ£€æŸ¥ Tokenï¼‰
- **RateLimitMiddleware**: é™åˆ¶è¯·æ±‚é¢‘ç‡ï¼ˆæ¯ä¸ªç”¨æˆ·æœ€å¤š N æ¬¡/åˆ†é’Ÿï¼‰
- **CacheMiddleware**: ç¼“å­˜ GET è¯·æ±‚çš„å“åº”
- **CompressionMiddleware**: å‹ç¼©å“åº”å†…å®¹ï¼ˆæ¨¡æ‹Ÿï¼‰
- **ErrorHandlerMiddleware**: ç»Ÿä¸€å¤„ç†é”™è¯¯

### 2. ä¸­é—´ä»¶ç‰¹æ€§
- æ”¯æŒåŠ¨æ€æ·»åŠ å’Œç§»é™¤ä¸­é—´ä»¶
- æ”¯æŒä¸­é—´ä»¶çš„é¡ºåºè°ƒæ•´
- æ”¯æŒçŸ­è·¯å¤„ç†ï¼ˆä¸­é—´ä»¶å¯ä»¥ä¸­æ–­é“¾çš„ä¼ é€’ï¼‰
- æ”¯æŒä¸­é—´ä»¶çš„é…ç½®

### 3. è¯·æ±‚å’Œå“åº”
å®šä¹‰è¯·æ±‚å’Œå“åº”ç»“æ„ï¼š
```go
type Request struct {
    Method  string
    Path    string
    Headers map[string]string
    Body    string
    User    string
}

type Response struct {
    StatusCode int
    Body       string
    Headers    map[string]string
}
```

### 4. ä¸­é—´ä»¶ç®¡ç†å™¨
å®ç°ä¸­é—´ä»¶ç®¡ç†å™¨ï¼š
- `Use(middleware)`: æ·»åŠ ä¸­é—´ä»¶
- `Handle(request)`: å¤„ç†è¯·æ±‚
- `Remove(middleware)`: ç§»é™¤ä¸­é—´ä»¶

## è¾“å…¥è¾“å‡ºç¤ºä¾‹

### ç¤ºä¾‹ 1: æ­£å¸¸è¯·æ±‚æµç¨‹

**è¾“å…¥**:
```go
app := NewApp()
app.Use(NewLoggerMiddleware())
app.Use(NewAuthMiddleware())
app.Use(NewBusinessHandler())

req := &Request{
    Method: "GET",
    Path:   "/api/users",
    Headers: map[string]string{
        "Authorization": "Bearer token123",
    },
}

app.Handle(req)
```

**è¾“å‡º**:
```
[Logger] GET /api/users - å¼€å§‹å¤„ç†
[Auth] éªŒè¯ç”¨æˆ·èº«ä»½
[Auth] âœ“ ç”¨æˆ·è®¤è¯æˆåŠŸ: user1
[Business] å¤„ç†ä¸šåŠ¡é€»è¾‘
[Business] âœ“ ä¸šåŠ¡å¤„ç†å®Œæˆ
[Logger] GET /api/users - å®Œæˆå¤„ç†ï¼Œè€—æ—¶: 52msï¼ŒçŠ¶æ€ç : 200
```

### ç¤ºä¾‹ 2: è®¤è¯å¤±è´¥

**è¾“å…¥**:
```go
req := &Request{
    Method: "GET",
    Path:   "/api/users",
    Headers: map[string]string{},
}

app.Handle(req)
```

**è¾“å‡º**:
```
[Logger] GET /api/users - å¼€å§‹å¤„ç†
[Auth] éªŒè¯ç”¨æˆ·èº«ä»½
[Auth] âœ— æœªæä¾›è®¤è¯ä»¤ç‰Œ
[Logger] GET /api/users - å®Œæˆå¤„ç†ï¼Œè€—æ—¶: 5msï¼ŒçŠ¶æ€ç : 401

å“åº”: 401 - Unauthorized: Missing token
```

### ç¤ºä¾‹ 3: é™æµ

**è¾“å…¥**:
```go
app := NewApp()
app.Use(NewLoggerMiddleware())
app.Use(NewAuthMiddleware())
app.Use(NewRateLimitMiddleware(3))
app.Use(NewBusinessHandler())

// å‘é€4æ¬¡è¯·æ±‚
for i := 1; i <= 4; i++ {
    req := &Request{
        Method: "GET",
        Path:   "/api/data",
        Headers: map[string]string{
            "Authorization": "Bearer token123",
        },
    }
    app.Handle(req)
}
```

**è¾“å‡º**:
```
ç¬¬ 1 æ¬¡è¯·æ±‚:
[Logger] GET /api/data - å¼€å§‹å¤„ç†
[Auth] âœ“ ç”¨æˆ·è®¤è¯æˆåŠŸ: user1
[RateLimit] ç”¨æˆ· user1 çš„è¯·æ±‚æ¬¡æ•°: 1/3
[RateLimit] âœ“ è¯·æ±‚é¢‘ç‡æ­£å¸¸
[Business] âœ“ ä¸šåŠ¡å¤„ç†å®Œæˆ
[Logger] GET /api/data - å®Œæˆå¤„ç†ï¼Œè€—æ—¶: 55msï¼ŒçŠ¶æ€ç : 200

...

ç¬¬ 4 æ¬¡è¯·æ±‚:
[Logger] GET /api/data - å¼€å§‹å¤„ç†
[Auth] âœ“ ç”¨æˆ·è®¤è¯æˆåŠŸ: user1
[RateLimit] ç”¨æˆ· user1 çš„è¯·æ±‚æ¬¡æ•°: 4/3
[RateLimit] âœ— ç”¨æˆ· user1 è¶…è¿‡è¯·æ±‚é™åˆ¶
[Logger] GET /api/data - å®Œæˆå¤„ç†ï¼Œè€—æ—¶: 8msï¼ŒçŠ¶æ€ç : 429

å“åº”: 429 - Too Many Requests
```

## æç¤º

ğŸ’¡ **æç¤º 1**: ä½¿ç”¨è´£ä»»é“¾æ¨¡å¼ç»„ç»‡ä¸­é—´ä»¶ï¼Œæ¯ä¸ªä¸­é—´ä»¶å†³å®šæ˜¯å¦ç»§ç»­ä¼ é€’è¯·æ±‚ã€‚

ğŸ’¡ **æç¤º 2**: ä¸­é—´ä»¶å¯ä»¥åœ¨è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶å‰åæ‰§è¡Œé€»è¾‘ï¼ˆç±»ä¼¼è£…é¥°å™¨ï¼‰ã€‚

ğŸ’¡ **æç¤º 3**: ä½¿ç”¨ context æˆ–è¯·æ±‚å¯¹è±¡ä¼ é€’ä¸­é—´ä»¶ä¹‹é—´çš„æ•°æ®ã€‚

ğŸ’¡ **æç¤º 4**: è€ƒè™‘ä½¿ç”¨å‡½æ•°ç±»å‹ç®€åŒ–ä¸­é—´ä»¶çš„å®šä¹‰ã€‚

ğŸ’¡ **æç¤º 5**: æ³¨æ„å¤„ç†é”™è¯¯æƒ…å†µï¼Œä¸­é—´ä»¶åº”è¯¥èƒ½å¤Ÿä¼˜é›…åœ°å¤„ç†å¼‚å¸¸ã€‚

## è¯„åˆ†æ ‡å‡†

- [ ] **åŠŸèƒ½å®Œæ•´æ€§ (40%)**
  - å®ç°æ‰€æœ‰è¦æ±‚çš„ä¸­é—´ä»¶
  - ä¸­é—´ä»¶é“¾æ­£å¸¸å·¥ä½œ
  - æ”¯æŒçŸ­è·¯å¤„ç†

- [ ] **ä»£ç è´¨é‡ (30%)**
  - ä»£ç ç»“æ„æ¸…æ™°
  - å‘½åè§„èŒƒ
  - é€‚å½“çš„æ³¨é‡Š

- [ ] **è®¾è®¡æ¨¡å¼åº”ç”¨ (20%)**
  - æ­£ç¡®ä½¿ç”¨è´£ä»»é“¾æ¨¡å¼
  - ä¸­é—´ä»¶è®¾è®¡åˆç†
  - æ˜“äºæ‰©å±•

- [ ] **é”™è¯¯å¤„ç† (10%)**
  - å¤„ç†å„ç§é”™è¯¯æƒ…å†µ
  - æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
  - é”™è¯¯ä¸å½±å“å…¶ä»–è¯·æ±‚

## æ‰©å±•æŒ‘æˆ˜

å¦‚æœä½ å®Œæˆäº†åŸºæœ¬è¦æ±‚ï¼Œå¯ä»¥å°è¯•ä»¥ä¸‹æ‰©å±•åŠŸèƒ½ï¼š

1. **æ¡ä»¶ä¸­é—´ä»¶**: æ ¹æ®è¯·æ±‚è·¯å¾„æˆ–æ–¹æ³•é€‰æ‹©æ€§åº”ç”¨ä¸­é—´ä»¶
2. **ä¸­é—´ä»¶åˆ†ç»„**: æ”¯æŒä¸ºä¸åŒçš„è·¯ç”±ç»„åº”ç”¨ä¸åŒçš„ä¸­é—´ä»¶
3. **å¼‚æ­¥ä¸­é—´ä»¶**: æ”¯æŒå¼‚æ­¥å¤„ç†çš„ä¸­é—´ä»¶
4. **ä¸­é—´ä»¶ä¼˜å…ˆçº§**: æ”¯æŒè®¾ç½®ä¸­é—´ä»¶çš„ä¼˜å…ˆçº§
5. **ä¸­é—´ä»¶ç›‘æ§**: ç»Ÿè®¡æ¯ä¸ªä¸­é—´ä»¶çš„æ‰§è¡Œæ—¶é—´å’Œè°ƒç”¨æ¬¡æ•°
6. **ä¸­é—´ä»¶çƒ­é‡è½½**: æ”¯æŒåœ¨è¿è¡Œæ—¶åŠ¨æ€æ›´æ–°ä¸­é—´ä»¶é…ç½®

## å‚è€ƒèµ„æº

- è´£ä»»é“¾æ¨¡å¼ç†è®ºæ–‡æ¡£: `theory/03-chain.md`
- ä¸­é—´ä»¶é“¾ç¤ºä¾‹: `examples/chain/middleware_chain.go`
- å®¡æ‰¹æµç¨‹ç¤ºä¾‹: `examples/chain/approval_chain.go`
