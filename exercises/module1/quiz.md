# Bug 根因分析 - 问答测试

## 说明

这个测试包含 10 个问题，用于验证你对 HPFS Bug 根本原因的理解。

每题 10 分，总分 100 分。建议在完成代码注释和时序分析练习后再做这个测试。

---

## 问题 1: Bug 性质判断 (10分)

HPFS Flow Control Bug 是什么类型的问题？

A. 硬件资源不足  
B. 网络配置错误  
C. 并发资源管理错误  
D. 数据库连接问题  

**你的答案**: ___

**解释**:
```
_________________________________________________________________
_________________________________________________________________
```

---

## 问题 2: 全局 Channel 的作用 (10分)

`totalFlowTokenChan` 的设计目的是什么？

A. 限制单个任务的流量  
B. 限制所有任务的总流量  
C. 用于任务间通信  
D. 用于错误处理  

**你的答案**: ___

**解释**:
```
_________________________________________________________________
_________________________________________________________________
```

---

## 问题 3: Channel 生命周期 (10分)

在原始代码中，`totalFlowTokenChan` 什么时候被关闭？

A. 每个任务完成时  
B. 全局 context 取消时  
C. 所有任务完成时  
D. 从不关闭  

**你的答案**: ___

**这样设计的问题是什么？**
```
_________________________________________________________________
_________________________________________________________________
```

---

## 问题 4: 嵌套 Select 行为 (10分)

在下面的代码中，当 `totalFlowTokenChan` 关闭时，`break` 语句会跳到哪里？

```go
out:
for {
    select {
    case _, ok := <-tokensChan:
        if !ok { break }
        
        select {
        case _, ok := <-f.totalFlowTokenChan:
            if !ok {
                break  // ← 这个 break 跳到哪里？
            }
        }
        
    case <-f.ctx.Done():
        break out
    }
    
    // 继续执行...
}
```

A. 跳出外层 for 循环  
B. 跳出内层 select  
C. 跳出外层 select  
D. 跳到 out 标签  

**你的答案**: ___

**为什么这会导致问题？**
```
_________________________________________________________________
_________________________________________________________________
```

---

## 问题 5: Panic 触发机制 (10分)

Panic 的直接原因是什么？

A. 读取已关闭的 channel  
B. 向已关闭的 channel 发送数据  
C. Context 取消  
D. 内存不足  

**你的答案**: ___

**在代码的哪个位置触发？**
```
文件: _______________________
行号: _______________________
```

---

## 问题 6: 竞态条件 (10分)

这个 bug 的竞态条件是什么？

A. 两个任务同时读取 channel  
B. 一个任务关闭 channel，另一个任务仍在使用  
C. 两个任务同时写入 channel  
D. Context 取消的时序不确定  

**你的答案**: ___

**为什么这是竞态条件？**
```
_________________________________________________________________
_________________________________________________________________
```

---

## 问题 7: 触发概率 (10分)

在什么情况下 bug 更容易触发？

A. 单个任务  
B. 两个并发任务，数据量小  
C. 两个并发任务，数据量大  
D. 多个串行任务  

**你的答案**: ___

**原因是什么？**
```
_________________________________________________________________
_________________________________________________________________
```

---

## 问题 8: 环境相关性 (10分)

这个 bug 是否与运行环境相关？

A. 是，只在 CPU 不足时触发  
B. 是，只在内存不足时触发  
C. 否，任何环境下并发时都会触发  
D. 是，只在 Kubernetes 环境触发  

**你的答案**: ___

**为什么？**
```
_________________________________________________________________
_________________________________________________________________
```

---

## 问题 9: defer 的危险性 (10分)

在 `dispatchToken` 函数中，`defer close(tokenChan)` 的问题是什么？

```go
func (f *FlowControlManager) dispatchToken(..., tokenChan chan int, ctx context.Context) {
    go func(ctx context.Context) {
        defer func() {
            close(tokenChan)  // ← 这里有什么问题？
        }()
        
        for {
            select {
            case <-ctx.Done():
                return
            // ...
            }
        }
    }(ctx)
}
```

A. defer 不会执行  
B. 关闭了不应该关闭的 channel  
C. 没有检查是否还有其他 goroutine 在使用  
D. 应该使用 panic 而不是 close  

**你的答案**: ___

**正确的做法应该是什么？**
```
_________________________________________________________________
_________________________________________________________________
```

---

## 问题 10: 根本原因总结 (10分)

用一句话总结这个 bug 的根本原因：

```
_________________________________________________________________
_________________________________________________________________
```

**这个 bug 反映了什么样的设计缺陷？**

A. 缺少错误处理  
B. 缺少并发安全机制  
C. 缺少性能优化  
D. 缺少日志记录  

**你的答案**: ___

---

## 评分标准

- **90-100分**: 优秀！完全理解 bug 的根本原因
- **80-89分**: 良好，理解大部分概念，需要加深对并发的理解
- **70-79分**: 及格，掌握基本概念，需要更多练习
- **< 70分**: 需要重新学习，建议回顾文档和代码

## 自我评分

**总分**: ___ / 100

**需要改进的地方**:
```
_________________________________________________________________
_________________________________________________________________
_________________________________________________________________
```

## 答案和解析

答案在 `exercises/answers/module1_answers.md` 文件中。

建议先独立完成测试，再查看答案。

## 下一步

- 如果得分 >= 80分：继续模块 2 的练习
- 如果得分 < 80分：重新阅读以下文档
  - [HPFS Bug 详细分析](../../review/HPFS_FLOW_CONTROL_BUG_ANALYSIS.md)
  - [HPFS Bug 流程图](../../review/HPFS_BUG_FLOW_DIAGRAM.md)
  - [Go Concurrency Patterns](https://go.dev/blog/pipelines)
