# Lab 22: 分层自主智能体 - 实现规划-执行-反思循环

## 🎯 学习目标

在`lab19`中您构建了基础的ReAct智能体，但它在处理需要几十步才能解决的复杂任务时，容易"迷失方向"。本实验将带您构建一个更强大、更有组织性的**分层智能体（Hierarchical Agent）**。您将学习并实践经典的"**规划者-执行者-反思者**" (Planner-Executor-Reflector) 设计模式，让您的Agent拥有初步的长期规划和动态纠错能力。

## 核心任务

1.  **理论学习：分层Agent的核心思想**
    *   **ReAct的局限**: 分析为什么单一的`Thought -> Action`循环难以胜任复杂任务，它缺乏高层次的规划和对整体进度的把控。
    *   **分层设计模式**:
        -   **规划者 (Planner)**: 一个高层次的"管理"LLM。它不执行具体任务，只负责接收用户的最终目标，并将其**分解**成一个包含多个步骤的、逻辑清晰的计划（Plan）。这个计划通常是一个结构化的格式，如JSON或YAML。
        -   **执行者 (Executor)**: 一个或多个低层次的"行动"Agent（可以直接复用您在`lab19`中构建的ReAct智能体）。它接收来自规划者的**单步指令**，调用工具完成具体、明确的任务，并将执行结果返回。
        -   **反思者 (Reflector / Corrector)**: 通常由规划者兼任。在接收到执行者的结果后，规划者会进行"**反思**"，判断上一步任务是否成功、是否需要调整原计划（例如，如果上一步搜索失败，下一步可能需要换一个关键词重新搜索），从而实现动态的任务修正。

2.  **实践操作：构建一个分层研究员Agent**
    *   **定义角色和提示**:
        -   **规划者提示**: 设计一个系统提示，指示LLM扮演一个"项目经理"的角色，其任务是把一个复杂的研究问题分解成一系列可执行的步骤（如：`step_1: search_for_papers`, `step_2: summarize_results`, `step_3: draw_conclusions`）。
        -   **执行者提示**: 复用`lab19`的ReAct提示，让它能接收单步指令并使用工具。
    *   **实现主控循环**:
        1.  接收用户的一个复杂研究任务，例如："调研Mamba架构的核心思想，并与Transformer进行对比。"
        2.  **调用规划者**，生成一个JSON格式的任务计划。
        3.  **遍历计划**:
            -   从计划中取出第一步，将其作为目标交给**执行者Agent**。
            -   执行者完成任务后，返回其结果（`Observation`）。
            -   将执行结果和原始计划一起交还给**规划者**，让它进行**反思和修正**，生成更新后的计划。
            -   重复此过程，直到规划者宣布所有步骤完成。
    *   **结果合成**: 最后，将所有步骤的执行结果汇总，交给一个"报告员"LLM，生成最终的总结报告。

## 📝 预期成果

- 深刻理解分层智能体的设计思想，掌握规划-执行-反思的核心模式。
- 一个可以运行的、基于Python的分层智能体系统，能够将一个复杂任务分解并逐步完成。
- 掌握了如何让不同角色、不同提示的LLM协同工作，来解决单一Agent难以应对的复杂问题。
- 具备了设计更高级自主智能体架构的能力，为探索拥有长期记忆和自主演化能力的Agent打下基础。 